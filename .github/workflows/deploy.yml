name: Deploy to Cloudflare

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build:pages

      - name: Setup Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Create KV namespaces (if auto-create is enabled)
        if: ${{ vars.AUTO_CREATE_KV == 'true' }}
        run: |
          # åˆ›å»ºUSERS KVå‘½åç©ºé—´
          USERS_KV_ID=$(wrangler kv:namespace create "USERS" --preview=false --format=json | jq -r '.id')
          echo "USERS_KV_ID=$USERS_KV_ID" >> $GITHUB_ENV
          
          # åˆ›å»ºUSERSé¢„è§ˆKVå‘½åç©ºé—´
          USERS_PREVIEW_KV_ID=$(wrangler kv:namespace create "USERS" --preview=true --format=json | jq -r '.id')
          echo "USERS_PREVIEW_KV_ID=$USERS_PREVIEW_KV_ID" >> $GITHUB_ENV
          
          # åˆ›å»ºKEYS KVå‘½åç©ºé—´
          KEYS_KV_ID=$(wrangler kv:namespace create "KEYS" --preview=false --format=json | jq -r '.id')
          echo "KEYS_KV_ID=$KEYS_KV_ID" >> $GITHUB_ENV
          
          # åˆ›å»ºKEYSé¢„è§ˆKVå‘½åç©ºé—´
          KEYS_PREVIEW_KV_ID=$(wrangler kv:namespace create "KEYS" --preview=true --format=json | jq -r '.id')
          echo "KEYS_PREVIEW_KV_ID=$KEYS_PREVIEW_KV_ID" >> $GITHUB_ENV
          
          # æ›´æ–°wrangler.tomlæ–‡ä»¶
          sed -i "s/your-users-kv-id/$USERS_KV_ID/g" wrangler.toml
          sed -i "s/your-users-kv-preview-id/$USERS_PREVIEW_KV_ID/g" wrangler.toml
          sed -i "s/your-keys-kv-id/$KEYS_KV_ID/g" wrangler.toml
          sed -i "s/your-keys-kv-preview-id/$KEYS_PREVIEW_KV_ID/g" wrangler.toml

      - name: Deploy to Cloudflare
        run: wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Output deployment URL
        run: |
          echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ åº”ç”¨URL: https://${{ vars.CLOUDFLARE_PROJECT_NAME }}.pages.dev"
          echo "ğŸ“Š æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://dash.cloudflare.com/pages" 